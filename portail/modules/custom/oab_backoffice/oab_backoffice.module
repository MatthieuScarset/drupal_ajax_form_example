<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\editor\Entity\Editor;
use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\Core\Database\Database;
use Drupal\image\Entity\ImageStyle;
use Drupal\Core\Entity\EntityInterface;
use \Drupal\file\Entity\File;
use Drupal\Core\Datetime;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\node\Entity\Node;
use Drupal\entity\Revision\RevisionableContentEntityBase;
use Drupal\workbench_moderation\Entity\ModerationState;
use \Drupal\oab_dvi\DviHelper;

//include_once 'includes/mediatheque.inc';
define ('CONTENT_TAXO_FIELDS', serialize(array('field_region',
	'field_job_profile',
	'field_market_segment',
	'field_industry',
	'field_solution',
	'field_partner_type',
	'field_document_type',
	'field_sub_family',
	'field_subhome')));


// Fichier pour le hook_form_alter qui commencait à prendre trop de place
module_load_include('inc', 'oab_backoffice', 'includes/form_alter');



function oab_backoffice_mail($key, &$message, $params) {
    $token_service = \Drupal::token();
    $config = \Drupal::config('oab.gdpr_settings');

    switch ($key) {
        case 'gdpr_spoc_notice':
            $message['subject'] = $token_service->replace($config->get('mail_spoc_object'), ['webform' => $params['webform']]);
            $message['body'][] = $token_service->replace($config->get('mail_spoc_body'), ['webform' => $params['webform']]);
            break;
        case 'gdpr_creator_notice':
            $message['subject'] = $token_service->replace($config->get('mail_creator_object'), ['webform' => $params['webform']]);
            $message['body'][] = $token_service->replace($config->get('mail_creator_body'), ['webform' => $params['webform']]);
            break;
        case 'gdpr_business_owner_notice':
            $message['subject'] = $token_service->replace($config->get('mail_business_owner_object'), ['webform' => $params['webform']]);
            $message['body'][] = $token_service->replace($config->get('mail_business_owner_body'), ['webform' => $params['webform']]);
            break;
        case 'gdpr_publish_notice':
            $message['subject']  = $token_service->replace($config->get('mail_validation_object'), ['webform' => $params['webform']]);
            $message['body'][]  = $token_service->replace($config->get('mail_validation_body'), ['webform' => $params['webform']]);
            break;
    }
}


function oab_backoffice_node_access(Drupal\node\Entity\Node $entity, $operation, \Drupal\Core\Session\AccountInterface $account) {

   if ($entity->getType() == 'webform' && $operation == 'view') {
       if ($entity->get('webform')->count() > 0 ) {
           $webform_value = $entity->get('webform')->first()->getValue();
           $webform_machine_name = $webform_value['target_id'];
           $webform_entity = \Drupal::entityTypeManager()->getStorage('webform')->load($webform_machine_name);
           if ($webform_entity != null && $webform_entity instanceof Drupal\webform\Entity\Webform) {
               return _is_webform_authorized($webform_entity, $operation, $account);
           }
       }

   }

    return Drupal\Core\Access\AccessResult::neutral();
}

/**
 * Gestion des droits d'accès à un webform
 */
function oab_backoffice_webform_access(Drupal\webform\Entity\Webform $entity, $operation, \Drupal\Core\Session\AccountInterface $account) {
    return _is_webform_authorized($entity, $operation, $account);
}


/**
 * Je regroupe tout dans une fonction perso, parce que je m'en sers dans plusieurs hook_access
 */
function _is_webform_authorized(Drupal\webform\Entity\Webform $entity, $operation, \Drupal\Core\Session\AccountInterface $account) {
    /**
     * Si l'utilisateur est un business owner, je lui donne les droits que sur les webforms auxquels il est business owner
     * pour voir les soumissions et faire des modifs
     */
    if (in_array('webform_business_owner', $account->getRoles())) {
        $form_bo = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner'));
        if ( ( $operation == "submission_view_any" || $operation == "update" )
            && $form_bo !== null
            && $form_bo->id() == $account->id()) {
            return Drupal\Core\Access\AccessResult::allowed();
        }
    }

    ##Pour l'accès aux données et à leur telechargement
    if ($operation == "submission_view_any" && in_array('webform_business_analyst', $account->getRoles())) {
        ##Je recupère la liste des business analysts du formulaire pour checker que les utilisateurs en font partis
        $business_analaysts_list = $entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_analysts');

        if (array_key_exists($account->id(), $business_analaysts_list)) {
            return Drupal\Core\Access\AccessResult::allowed();
        }

    }


    ## Submission page => page d'affichage du formulaire
    if ($operation == "submission_page" || $operation == "view") {

        $allowed = _check_authorized_view($entity, $account);
        if ($allowed) {
            return Drupal\Core\Access\AccessResult::allowed();
        } elseif( $allowed == false) {
            return Drupal\Core\Access\AccessResult::forbidden();
        } elseif ($allowed == null) {
            return Drupal\Core\Access\AccessResult::neutral();
        }
    }

    /* A garder pour afficher toutes les permissions des webforms
     * if (in_array('webform_manager', $account->getRoles())) {
        echo $entity->label() . " => " . $operation . " <br /> ";
    }*/


    return Drupal\Core\Access\AccessResult::neutral();
}


function _check_authorized_view($entity, $account) {
    $ret = false;
    $is_published = $entity->getThirdPartySetting('oab_gdpr', 'gdpr_form_published');

    // Petit hack pour les contenus qui n'ont pas encore leurs réglages GDPR
    if ($is_published == null) {
        return true;
    }

    //echo "is published : $is_published"; die();
    ##Je fais les accès au formulaire en spécifique si le formulaire n'est pas publié
    if ($is_published != 1 ) {

        ## Si c'est un webform admin ou si c'est l'administrateur
        if (in_array('webform_admin', $account->getRoles())
            || $account->id() == 1) {
            $ret = true;
        }

        ## S'il est business owner, il doit être le BO du form pour le voir
        if (in_array('webform_business_owner', $account->getRoles())
            && $entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner') == $account->id()
        ) {
            $ret = true;
        }


        ## S'il est SPOC Securité, il doit être le SPOC du form pour le voir
        if (in_array('webform_spoc_securite', $account->getRoles())
            && $entity->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security') == $account->id()
        ) {
            $ret = true;
        }


        ## S'il est webform manager, il doit etre le "owner" du form pour le voir
        if (in_array('webform_manager', $account->getRoles())
            && $entity->getOwnerId() == $account->id()
        ) {
            $ret = true;
        }

        # Si aucune condition n'est remplie, on interdit l'accès au webform
        return $ret;
    } else {
        // SI le webform est publié, on return true;
        return true;
    }

}

/*
* implement hook_token_info()
*/
function oab_backoffice_token_info(){
    $types['gdpr'] = array(
        'name' => t('GDPR tokens'),
        'description' => t('Token designed for webform mails')
    );
    $tokens['business-owner-mail'] = array(
        'name' => t('Business owner mail'),
        'description' => t('Business owner mail')
    );
    $tokens['creator-pseudo'] = array(
        'name' => t('Creator pseudo'),
        'description' => t('Creator pseudo')
    );
    $tokens['creator-mail'] = array(
        'name' => t('Creator mail'),
        'description' => t('Creator mail')
    );
    $tokens['form-title'] = array(
        'name' => t('Form title'),
        'description' => t('Form title')
    );
    $tokens['form-expiration-date'] = array(
        'name' => t('Form expiration date'),
        'description' => t('Form expiration date')
    );
    $tokens['form-id'] = array(
        'name' => t('Webform machine name'),
        'description' => t('Machine name of the webform')
    );
    $tokens['spoc-pseudo'] = array(
        'name' => t('Spoc security pseudo'),
        'description' => t('Spoc security pseudo')
    );
    $tokens['spoc-mail'] = array(
        'name' => t('Spoc security mail'),
        'description' => t('Spoc security mail')
    );


    return array(
        'types' => $types,
        'tokens' => array(
            'gdpr' => $tokens
        )
    );
}

/*
* implement hook_token()
*/
function oab_backoffice_tokens($type, $tokens, array $data, array $options, \Drupal\Core\Render\BubbleableMetadata $bubbleable_metadata){
    $replacements = array();

    if (isset($data['webform'])) {
        $webform = $data['webform'];
        if($type == 'gdpr') {
            foreach ($tokens as $name => $original) {
                switch ($name) {
                    case 'business-owner-mail':
                        $business_owner = \Drupal\user\Entity\User::load($webform->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner'));
                        if ($business_owner !== null) {
                            $replacements[$original] = $business_owner->getEmail();
                        } else {
                            drupal_set_message(t("Le Business Owner n'a pas pu etre trouvé"), 'error', true);
                        }
                        break;
                    case 'creator-pseudo':
                        $replacements[$original] = $webform->getOwner()->getDisplayName();
                        break;
                    case 'creator-mail':
                        $replacements[$original] = $webform->getOwner()->getEmail();
                        break;
                    case 'form-title':
                        $replacements[$original] = $webform->get('title');
                        break;
                    case 'form-expiration-date':
                        $date = new \DateTime($webform->getThirdPartySetting('oab_gdpr', 'gdpr_expiration_date'));
                        $replacements[$original] = $date->format('d/m/Y');
                        break;
                    case 'data-delete-date':
                        $date = new \DateTime($webform->getThirdPartySetting('oab_gdpr', 'gdpr_data_delete_date'));
                        $replacements[$original] = $date->format('d/m/Y');
                        break;
                    case 'form-id':
                        $replacements[$original] = $webform->id();
                        break;
                    case 'spoc-pseudo':
                        $spoc = \Drupal\user\Entity\User::load($webform->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security'));
                        if ($spoc !== null) {
                            $replacements[$original] = $spoc->label();
                        } else {
                            drupal_set_message(t("Le SPOC Securité n'a pas pu etre trouvé"), 'error', true);
                        }
                        break;
                    case 'spoc-mail':
                        $spoc = \Drupal\user\Entity\User::load($webform->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security'));
                        if ($spoc !== null) {
                            $replacements[$original] = $spoc->getEmail();
                        } else {
                            drupal_set_message(t("Le SPOC Securité n'a pas pu etre trouvé"), 'error', true);
                        }
                        break;
                    case 'delete-data-date':
                        $date = new \DateTime($webform->getThirdPartySetting('oab_gdpr', 'gdpr_delete_data_date'));
                        $replacements[$original] = $date->format('d/m/Y');
                        break;
                }
            }
        }
    }

    return $replacements;
}

/*
 * A la creation d'un webform, on envoie des emails
 */
function oab_backoffice_webform_insert(Drupal\webform\Entity\Webform $entity) {
    $current_user = Drupal::currentUser();
    $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();

    //Lorsque le formulaire est créé par le webform admin, on n'envoie pas de mail
    if (!in_array('webform_admin', $current_user->getRoles())) {

        #mail to SPOC Security
        $spoc_security = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security'));
        if ($spoc_security !== null) {
            \Drupal::service('plugin.manager.mail')
                ->mail('oab_backoffice', 'gdpr_spoc_notice', $spoc_security->getEmail(), $current_language, array('webform'=> $entity));
        } else {
            drupal_set_message(t("L'email au SPOC Securité n'a pas pu être envoyé"), 'error', true);
        }

        # mail au createur du webform
        $mail_creator = $current_user->getEmail();
        \Drupal::service('plugin.manager.mail')
            ->mail('oab_backoffice', 'gdpr_creator_notice', $mail_creator, $current_language,  array('webform'=> $entity));

        # mail au business owner
        $business_owner = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner'));
        if ($business_owner !== null ) {
            $mail_business_owner = $business_owner->getEmail();
            \Drupal::service('plugin.manager.mail')
                ->mail('oab_backoffice', 'gdpr_business_owner_notice', $mail_business_owner, $current_language,  array('webform'=> $entity));
        } else {
            drupal_set_message(t("L'email au Business Owner n'a pas pu être envoyé"), 'error', true);
        }
    }

}


/**
 * Fonction appellée à la validation de l'edition d'un webform pour sauvegarder nos paramètres spécifiques à la GDPR
 */
function _oab_webform_gdpr_submit(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {

    if ($entity = $form_state->getFormObject()->getEntity()) {
        $entity->setThirdPartySetting('oab_gdpr', 'gdpr_business_owner', $form_state->getValue('gdpr_business_owner'));
        $entity->setThirdPartySetting('oab_gdpr', 'gdpr_spoc_security', $form_state->getValue('gdpr_spoc_security'));
        $entity->setThirdPartySetting('oab_gdpr', 'gdpr_expiration_date', $form_state->getValue('gdpr_expiration_date'));
        $entity->setThirdPartySetting('oab_gdpr', 'gdpr_business_analysts', $form_state->getValue('gdpr_business_analysts'));
        $entity->setThirdPartySetting('oab_gdpr', 'gdpr_form_published', $form_state->getValue('gdpr_form_published'));
    }
}


/**
 * Liste des utilisateurs ayant le role Business Analyst
 */
function _business_analysts_list() {
    $query = \Drupal::database()->select('users', 'u');
    $query->fields('u', array('uid'));
    $query->innerJoin('user__roles', 'r', 'r.entity_id = u.uid');
    $query->join('users_field_data', 'd', 'u.uid = d.uid');
    $query->condition('r.roles_target_id', 'webform_business_analyst');
    $query->fields('d', array('name'));
    $query->orderBy('d.name');

    $result = $query->execute();

    $users = array();
    foreach ($result as $user) {
        $users[$user->uid] = $user->name;
    }
    return $users;
}

/**
 * Implements hook_form_alter().
 */
function oab_backoffice_form_alter(&$form, FormStateInterface $form_state, $form_id) {


    if ($form_id == "node_webform_form") {
        $options = $form['webform']['widget'][0]['target_id']["#options"];

        $ret = [];
        $current_user = Drupal::currentUser();
        foreach ($options as $machine_name => $name) {
            if (is_array($name)) {
                $ret[$machine_name] = [];

                foreach($name as $key => $value) {
                    $webform = \Drupal::entityTypeManager()->getStorage('webform')->load($key);
                    if (_check_authorized_view($webform, $current_user)) {
                        $ret[$machine_name][$key] = $value;
                    }
                }

                if (count($ret[$machine_name]) == 0) {
                    unset($ret[$machine_name]);
                }
            } else {
                $webform = \Drupal::entityTypeManager()->getStorage('webform')->load($machine_name);
                if (_check_authorized_view($webform, $current_user)) {
                    $ret[$machine_name] = $name;
                }
            }
        }

        $form['webform']['widget'][0]['target_id']["#options"] = $ret;
    }

    /**
     * Pour la GDPR, hook des webform pour ajouter des éléments
     */
    if ($form_id == "webform_add_form" || $form_id == 'webform_settings_form') {
        $entity = $form_state->getFormObject()->getEntity();

        $form['gdpr_informations'] = [
            '#type' => 'details',
            '#title'    => t('GDPR Information'),
            '#open' => true,
        ];

        $form['gdpr_informations']['gdpr_form_published'] = [
            '#type' => 'checkbox',
            '#title'    => t('Form published'),
            '#default_value' => ($entity->getThirdPartySetting('oab_gdpr', 'gdpr_form_published') !== null ) ? $entity->getThirdPartySetting('oab_gdpr', 'gdpr_form_published') : false,
            '#access' => false,
            "#disabled" => "disabled"
        ];

        $business_owner = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner'));
        $current_user = Drupal::currentUser();
        // j'affiche la checkbox si on est dans les settings du webform et l'utilisateur connecté est le "business owner" du formulaire en question
        if ($form_id == 'webform_settings_form') {

            ##Je n'affiche la publication que si on édite le formulaire, pas à la création
            $form['gdpr_informations']['gdpr_form_published']['#access'] = true;

            ## Je le rend cliquable que si l'utilisateur courant est le business_owner
            if (  $current_user->id() == 1
                || ( $business_owner !== null
                    && (
                         in_array('webform_admin', $current_user->getRoles())
                        ||  (
                            in_array('webform_business_owner', $current_user->getRoles())
                            && $current_user->id() === $business_owner->id()
                        )
                    )
                )
            ) {
               $form['gdpr_informations']['gdpr_form_published']['#disabled'] = false;
            }
        }


        $form['gdpr_informations']['gdpr_business_owner'] = [
            '#type' => 'entity_autocomplete',
            '#title'    => t('Business Owner'),
            '#default_value' => \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner')),
            '#target_type' => "user",
            '#settings' => [
                'match_operator'    => "CONTAINS"
            ],
            "#selection_settings"   => [
                'include_anonymous' => false,
                'filter' => [
                    'role' => ['webform_business_owner'],
                ],
            ],
            '#required' => true,
        ];


        $form['gdpr_informations']['gdpr_business_analysts'] = [
            '#type' => 'select',
            '#multiple' => true,
            '#title'    => t('Business Analysts'),
            '#options' => _business_analysts_list(),
            '#description' => "Utilisez ctrl+click pour selectionner plusieurs utilisateurs",
            "#default_value"  => $entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_analysts')
        ];
        
        # Je donne les droits à l'admin de se selectionner
        if ($current_user->id() == 1) {
            $form['gdpr_informations']['gdpr_business_owner']["#selection_settings"]['filter']['role'][] = "administrator";
        }


        $form['gdpr_informations']['gdpr_spoc_security'] = [
            '#type' => 'entity_autocomplete',
            '#title'    => t('SPOC Security'),
            "#default_value"    => \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security')),
            '#required' => true,
            '#target_type' => "user",
            '#settings' => [
                'match_operator'    => "CONTAINS"
            ],
            "#selection_settings"   => [
                'include_anonymous' => false,
                'filter' => [
                    'role' => ['webform_spoc_securite'],
                ],
            ],
        ];
        # Je donne les droits à l'admin de se selectionner
        if ($current_user->id() == 1) {
            $form['gdpr_informations']['gdpr_spoc_security']["#selection_settings"]['filter']['role'][] = "administrator";
        }


        $form['gdpr_informations']['gdpr_expiration_date'] = [
            '#type' => 'date',
            '#title'    => t('Form expiration date'),
            '#default_value'    => $entity->getThirdPartySetting('oab_gdpr', 'gdpr_expiration_date')
        ];

        if (in_array('webform_manager', $current_user->getRoles())) {
            $form['gdpr_informations']['gdpr_expiration_date']['#required'] = true;
        }


        //array_unshift($form['actions']['submit']['#submit'],'_oab_webform_gdpr_submit' );

        ## Je place mon submit, pour éviter qu'il soit en dernière place, sinon ca crée des erreurs
        $old_submit = $form['actions']['submit']['#submit'];
        $submit = array_slice($old_submit, 0, count($old_submit) - 1, true) +
            ["ne_pas_supprimer" => "_oab_webform_gdpr_submit"] +
            array_slice($old_submit, count($old_submit) - 1, count($old_submit) - 1, true);

        $form['actions']['submit']['#submit'] = array_values($submit);
        $form['#validate'][] = '_oab_webform_gdpr_validate';
    }


    // Deplacement de la fonction dans une fichier .include spécifique pour ne pas surcharger ce fichier
    _in_hook_form_alter($form, $form_state, $form_id);

}


function oab_backoffice_entity_update(EntityInterface $entity) {

    /**
     * Envoi des mails aux users specifiés lors de la publication d'un webform
     */
    if ($entity instanceof Drupal\webform\Entity\Webform) {
        $current_user = Drupal::currentUser();
        $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();

        $old_webform = $entity->original;

        $isPublished = $entity->getThirdPartySetting('oab_gdpr', 'gdpr_form_published');
        $old_isPublished = $old_webform->getThirdPartySetting('oab_gdpr', 'gdpr_form_published');

        ## Si le webform vient d'etre publié et que ce n'est pas un admin qui vient de le publier
        if ($isPublished
            && $isPublished !== $old_isPublished
            && !in_array('webform_admin', $current_user->getRoles())
            && $current_user->id() != 1      #Je ne le fait pas pour l'admin et les ebform_admin
        ) {
            #mail to Everyone pour la validation

            $spoc = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_spoc_security'));
            if ($spoc !== null ) {
                $mail_spoc = $spoc->getEmail();
                \Drupal::service('plugin.manager.mail')
                    ->mail('oab_backoffice', 'gdpr_publish_notice', $mail_spoc, $current_language, array('webform' => $entity));
            }

            $mail_creator = $entity->getOwner()->getEmail();
            \Drupal::service('plugin.manager.mail')
                ->mail('oab_backoffice', 'gdpr_publish_notice', $mail_creator, $current_language, array('webform'=> $entity));

            $business_owner = \Drupal\user\Entity\User::load($entity->getThirdPartySetting('oab_gdpr', 'gdpr_business_owner'));
            if ($business_owner !== null) {
                $mail_business_owner = $business_owner->getEmail();
                \Drupal::service('plugin.manager.mail')
                    ->mail('oab_backoffice', 'gdpr_publish_notice', $mail_business_owner, $current_language, array('webform'=> $entity));
            }

        }
    }

    /** @var \Drupal\file\Entity\File $entity */
    if ($entity instanceof Drupal\file\Entity\File) {
        $image = \Drupal::service('image.factory')->get($entity->getFileUri());
        /** @var \Drupal\Core\Image\Image $image */
        if ($image->isValid()) {
            $image_uri = $entity->getFileUri();
            // on vide les caches en BDD (pas trouvé mieux pour la top zone)
            $connection = Database::getConnection();
            $connection->delete('cache_render')->condition('cid', '%topzone%', 'LIKE')->execute();
            // on regénère les styles
            $styles = ImageStyle::loadMultiple();
            /** @var \Drupal\image\Entity\ImageStyle $style */
            $tabRefresh = array(
                'file_entity_browser_thumbnail',
                'homepage_expertise',
                'homepage_solution_banner',
                'homepage_news',
                'homepage_top_zone',
                'large',
                'medium',
                'subhome',
                'thumbnail',
                'top_zone',
                'top_zone_big'
                );
            foreach ($styles as $style) {
                if(in_array($style->id(), $tabRefresh)){
                    $destination = $style->buildUri($image_uri);
                    $style->createDerivative($image_uri, $destination);
                }
            }
        }
    }
}

function oab_backoffice_menu_link_submit(&$form, FormStateInterface $form_state){
	$values = $form_state->getValues();
	$link_target = array();
	$link_icon = array();
	$link_classtag = array();

	if (isset($values['link_target'])
		&& !empty($values['link_target'])) {
		$link_target = trim($values['link_target']);
	}

	if (isset($values['link_icon'])
		&& !empty($values['link_icon'])) {
		$link_icon = trim($values['link_icon']);
	}

	if (isset($values['link_classtag'])
		&& !empty($values['link_classtag'])) {
		$link_classtag = trim($values['link_classtag']);
	}

	$menuLinkEntity = _oab_backoffice_get_menu_link_entity_from_form_state($form_state);
	$options = $menuLinkEntity->link->first()->options;

	$changed = FALSE;
	if (empty($link_target)) {
		if (!empty($options['target'])) {
			unset($options['target']);
			$changed = TRUE;
		}
	}
	else {
		$options['target'] = $link_target ? '_blank' : '_self' ;
		$changed = TRUE;
	}

	if (empty($link_icon)) {
		if (!empty($options['icon'])) {
			unset($options['icon']);
			$changed = TRUE;
		}
	}
	else {
		$options['icon'] = $link_icon ;
		$changed = TRUE;
	}

	if (empty($link_classtag)) {
		if (!empty($options['classtag'])) {
			unset($options['classtag']);
			$changed = TRUE;
		}
	}
	else {
		$options['classtag'] = $link_classtag ;
		$changed = TRUE;
	}

	if ($changed) {
		$menuLinkEntity->link->first()->options = $options;
		$menuLinkEntity->save();
	}
}


function oab_backoffice_ckeditor_css_alter(array &$css, Editor $editor) {
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/boosted/css/bootstrap-orange2015.min.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/boosted/css/boosted2015.min.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/font-awesome.min.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/background.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/buttons.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/shareIcons.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/textes.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/layout.css';
	$css[] = drupal_get_path('theme', 'theme_boosted') . '/css/templating/nodes.css';
}


function oab_backoffice_menu_local_tasks_alter(&$data, $route_name){
	if (isset($data['tabs'][0]) && is_array($data['tabs'][0])){
		foreach ($data['tabs'][0] AS $key => $value){
			if (isset($value['#link']['url'])){
				$local_task_link_url = $value['#link']['url'];
				$routeName = $local_task_link_url->getRouteName();
				switch ($routeName){
					case 'system.admin_content':
						$data['tabs'][0][$key]['#weight'] = 0;
						break;
					case 'view.dashboard.page_1':
						$data['tabs'][0][$key]['#weight'] = 1;
						break;
					case 'view.media.media_page_list':
						$data['tabs'][0][$key]['#weight'] = 2;
						break;
					case 'view.files.page_1':
						$data['tabs'][0][$key]['#weight'] = 3;
						break;
					case 'comment.admin':
						$data['tabs'][0][$key]['#weight'] = 4;
						break;
				}
			}
		}
	}
}



function _oab_backoffice_get_menu_link_entity_from_form_state(FormStateInterface $form_state){
	$buildInfo = $form_state->getBuildInfo();
	$menuLinkContentForm = $buildInfo['callback_object'];
	return $menuLinkContentForm->getEntity();
}

// ajout du type de rendu des champs "path" pour la traduction
function oab_backoffice_config_schema_info_alter(&$definitions) {
	$definitions['path']['form_element_class'] = '\Drupal\config_translation\FormElement\Textfield';
}


/**
 * Implements hook_library_info_alter().
 */
function oab_backoffice_library_info_alter(&$libraries, $extension) {
	if ($extension == 'oab_backoffice' && isset($libraries['jira'])) {
		$jira_url = \Drupal::config('block.block.jirareportblock')->get('settings');
		if (isset($jira_url['jira_report_code'])){
			$libraries['jira']['js'] = [$jira_url['jira_report_code'] => array('external' => true)];
		}
	}
}




/*
 function oab_backoffice_query_alter(Drupal\Core\Database\Query\AlterableInterface $query) {

  $node = \Drupal::routeMatch();
  $user = \Drupal::currentUser();
  if($node->getRouteName() == 'comment.admin' && $query->hasTag('entity_query_comment') && in_array("blogger", $user->getRoles())) {
    $query->condition('comment_field_data.uid', $user->id());
  }

}
*/

/**
 * Altération du formulairede mise en place des redirections
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function oab_backoffice_form_redirect_redirect_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id){
	//Pour ajouter le / après l'url et avant le champ source de la redirection
	// RUBYPORTAILOBS-2753 "Ajout d'un / avant le champs path dans les redirections"
	if(isset($form['redirect_source']['widget'][0]['path']['#field_prefix']))
	{
		$form['redirect_source']['widget'][0]['path']['#field_prefix'] = $form['redirect_source']['widget'][0]['path']['#field_prefix'].'/';
	}
}


function oab_backoffice_entity_embed_alter(&$build, $entity, &$context) {
	if (isset($build['#attributes']['data-align']) && $build['#attributes']['data-align'] == 'center') {
		$build['#attributes']['class'][] = 'text-align-center';
	}
}



/**
 * Implements hook_views_data_alter().
 */
function oab_backoffice_views_data_alter(array &$data) {
	/*$data['node']['node_month'] = array(
		'title' => t('Node month'),
		'field' => array(
			'title' => t('Node month'),
			'help' => t('Flags a specific node month.'),
			'id' => 'node_month',
		),
	);*/
	$data['node_field_data']['node_month'] = array(
		'title' => t('Node Month filter'),
		'filter' => array(
			'title' => t('Node month filter'),
			'help' => t('Provides a custom filter for nodes by the month of creation.'),
			'field' => 'created',
			'id' => 'node_month'
		),
	);
	$data['node_field_data']['node_year'] = array(
		'title' => t('Node Year filter'),
		'filter' => array(
			'title' => t('Node year filter'),
			'help' => t('Provides a custom filter for nodes by the year of creation.'),
			'field' => 'created',
			'id' => 'node_year'
		),
	);
}


/**
 * Implements hook_views_post_render().
 */
function oab_backoffice_views_post_render(Drupal\views\ViewExecutable $view) {

  /**
   * Modification de l'affichage des remontées pour l'autocomplete des rebonds
   * Ajout du type de contenu et du NID
   */
  if ($view->id() == 'rebond_entity_reference') {

    foreach ($view->result as $i => $result) {
      #On recupère les données nécessaires
      $node_type = $result->_entity->get('type')->entity->label();
      $node_id = $result->_entity->id();
      $node_label =  $result->_entity->getTitle();

      #On set la nouvelle valeur
      $view->result[$i]->_entity->get('title')->setValue(array(0=>"$node_label ($node_type : $node_id)"));
    }
  }

    if ($view->id() == 'product_autocomplete') {
        foreach ($view->result as $i => $result) {
            #On recupère les données nécessaires
            $node_lang = $result->_entity->language()->getName();
            $node_label =  $result->_entity->getTitle();
            $langcode = strtoupper(substr($node_lang, 0, 2));
            #On set la nouvelle valeur
           $view->result[$i]->_entity->get('title')->setValue(array(0=>"$node_label ($langcode)"));
        }
    }
}

/**
 * Implements hook_views_pre_render().
 */
function oab_backoffice_views_pre_render(Drupal\views\ViewExecutable $view) {

    if ($view->id() == 'content') {
      foreach ($view->result as $i => $result) {
            # On recupère les données nécessaires
         $node_type = $result->_entity->get('type')->entity->id();
          if($node_type == 'product'){
            $node_label =  $result->_entity->getTitle();
            $node_axiome_data =  $result->_entity->get('field_axiome_data')->getValue();
            if(isset($node_axiome_data[0]['value'])){
              $data = unserialize($node_axiome_data[0]['value']);
              if(isset($data['Attributes']['nom_offre_commerciale']) && $data['Attributes']['nom_offre_commerciale'] != ''){
                $offre_commerciale = $data['Attributes']['nom_offre_commerciale'];
                # On set la nouvelle valeur
                $view->result[$i]->_entity->get('title')->setValue(array(0=>"$offre_commerciale ($node_label)"));
              }
            }
          }

          if (isset($result->workbench_revision_tracker_revision_id)
            && $result->workbench_revision_tracker_revision_id != 0
            && $result->workbench_revision_tracker_revision_id !== null ) {

            #kint($result->workbench_revision_tracker_revision_id);

            $maRevision = node_revision_load($result->workbench_revision_tracker_revision_id);
            $moderationState = $maRevision->get('moderation_state')->getValue();
            #Obligé de load le ModerationState complet, il n'y est pas dans l'objet de la revision.....
            $moderationStateObject = ModerationState::load( $moderationState[0]['target_id']);
            $result->workbench_revision_tracker_revision_id = $moderationStateObject->get('label');

          }
      }
    }
}

function oab_backoffice_transliteration_overrides_alter(&$overrides, $langcode) {
    if ($langcode == 'ru') {
        // changements demandés par Alexandra (majuscules et minuscules)
        // caractère ч ӵ => ch
        $overrides[0x0447] = $overrides[0x0427] = $overrides[0x04F4] = $overrides[0x04F5] = 'ch';
        // caractère я => ya
        $overrides[0x042F] = $overrides[0x044F] = 'ya';
        // caractère ж ӂ ӝ => zh
        $overrides[0x04C1] = $overrides[0x04C2] = $overrides[0x0416] = $overrides[0x0436] = $overrides[0x04DC] = $overrides[0x04DD] = 'zh';
        // caractères Ё, ё => e
        $overrides[0x0401] = $overrides[0x0451] = "e";
        // caractères Й, й => i
        $overrides[0x0419] = $overrides[0x0439] = "i";
        // caractères Х, х => kh
        $overrides[0x0425] = $overrides[0x0445] = "kh";
        // caractères Ц, ц => ts
        $overrides[0x0426] = $overrides[0x0446] = "ts";
        // caractères Ш, ш => sh
        $overrides[0x0428] = $overrides[0x0448] = "sh";
        // caractères Щ, щ => sch
        $overrides[0x0429] = $overrides[0x0449] = "sch";
        // caractères Ы, ы, Ӹ, ӹ => i
        $overrides[0x042B] = $overrides[0x044B] = $overrides[0x04F8] = $overrides[0x04F9] = "i";
        // caractères Э, э, Ӭ, ӭ => e
        $overrides[0x042D] = $overrides[0x044D] = $overrides[0x04EC] = $overrides[0x04ED] = "e";
        // caractères Ю, ю => yu
        $overrides[0x042E] = $overrides[0x044E] = "yu";
    }
}

/**
 * Implements hook_cron().
 * Suppression des resultats des webforms de plus d'un an
 */
function oab_backoffice_cron() {
  ##Je fais la vérif' qu'une fois par jour, à 1h du mat'
  #(2h, mais du coup, y a 1h de decalage par rapport à l'heure D8)
    if( date('G',  \Drupal::time()->getCurrentTime()) == 2) {


        ## Je recupère tous les webforms existants et je boucle sur chacun d'entre eux,
        ## les règles de suppression dépendant des éléments du webform
        # => Si une date d'expiration a été définie, toutes les données sont supprimées 6 mois après la date d'expiration du formulaire
        # => Si non définie, les données sont supprimées 6 mois après leur soumission

        $webform_query =  \Drupal::entityQuery('webform');
        $webforms = $webform_query->execute();

        foreach ($webforms as $webform_id => $webform_data) {

            $webform_entity = \Drupal::entityTypeManager()->getStorage('webform')->load($webform_id);

            if ($webform_entity !== null) {

                $expire_date = $webform_entity->getThirdPartySetting('oab_gdpr', 'gdpr_expiration_date');

                if ($expire_date == null || $expire_date == ""){
                    ## SI le formulaire n'a pas de date d'expiration, je supprime toutes les soumissions qui ont plus de 6 mois
                    ## (soit gdpr_expiration_date n'existe pas, soit il est setté avec un string vide (résultat du form sans donnée)

                    ##je recupère la date d'il y a 6 mois
                    $date = new Datetime\DrupalDateTime('6 month ago', new \DateTimezone(DATETIME_STORAGE_TIMEZONE));
                    $formatted = $date->format('U');    ## Format milliseconde

                    ##Query pour retrouver toutes les submissions antérieures à un an
                    $query = \Drupal::entityQuery('webform_submission')
                        ->condition('created', $formatted, '<')
                        ->condition('webform_id', $webform_id, '=');
                    $results = $query->execute();

                    ##je load toutes les submissions trouvées
                    $storage = \Drupal::entityTypeManager()->getStorage('webform_submission');
                    $webform_submissions = $storage->loadMultiple($results);

                    ##Suppression de toutes les entités trouvées
                    $storage->delete($webform_submissions);

                } else {

                    ## S'il a une date d'expiration, je regarde si on est 6 mois après la date d'expiration
                    ## si c'est le cas, je supprime TOUTES les données

                    ## Je recrée l'objet date de la date de suppression que je set 6 mois
                    $expire_date = new \DateTime($webform_entity->getThirdPartySetting('oab_gdpr', 'gdpr_expiration_date'));
                    $expire_date->add(new \DateInterval('P6M'));

                    ## Today
                    $today = new \DateTime('now');

                    ## Je compare les 2 dates. Si today est avant la date de suppression,
                    $diff = $today->diff($expire_date);


                    ## Si invert est à un, c'est qu'on est en négatif, et il faut supprimer les données
                    if ($diff->invert == 1) {

                        ## Dans ce cas là, je supprime toutes les données du formulaire en question
                        $query = \Drupal::entityQuery('webform_submission')
                            ->condition('webform_id', $webform_id, '=');
                        $results = $query->execute();

                        ##je load toutes les submissions trouvées
                        $storage = \Drupal::entityTypeManager()->getStorage('webform_submission')->loadMultiple($results);
                        $webform_submissions = $storage->loadMultiple($results);

                        ##Suppression de toutes les entités trouvées
                        $storage->delete($webform_submissions);
                    }

                }
            }

        }




        #####################################
        #####################################
        # Suppression des elements du dossier d'export des listes de documents du site
        \Drupal\oab_backoffice\Controller\OabExportFileListController::clearStorageDir();


    }
}

/**
 * fonction qui retournent les valeurs disponibles pour le choix de la couleur du block Rebond Wysiwyg
 */
function oab_backoffice_paragraph_rebond_wysiwyg_allowed_values(FieldStorageConfig $definition, ContentEntityInterface $entity = NULL, $cacheable) {
  return [
    "#f60"        => "Orange",
    "#fff"        => "White",
    "#000"        => "Black",
    "#55bc87"     => "Green",
    "#a786d5"     => "Purple",
    "#4bb4e6"     => "Blue",
    "#ffd200"     => "Yellow",
    "#ffb4e6"     => "Pink",
    "#595959"     => "Grey",
    "#8F8C87"     => "Dark grey",
    "#58595b"     =>"Darker grey",
    "#333333"     => "Grey black",
  ];
}


/**
 * Ajout de vérification lors de la création d'un produit DVI
 *  Si l'utilisateur à coché la case "Produit DVI", alors il faut :
 *      - qu'il ait selectionné "Produits DVI" dans la taxo Subhome (rubrique)
 *      - qu'il ait selectionné au moins un element dans la taxo Market Segment DVI
 *
 * @param array $form
 * @param \Drupal\Core\Form\FormState $form_state
 */
function oab_backoffice_check_dvi_product_form_validate(array $form, Drupal\Core\Form\FormState &$form_state) {

  ##Je commence par recupérer les valeurs rentrées par l'user
  $userValues = $form_state->getUserInput();

  if (isset($userValues['langcode'][0]['value'])){
    $content_language = $userValues['langcode'][0]['value'];
  }
  else{
    $content_language = null;
  }

  ## Si l'utilisateur a coché "Produit DVI", on effectue des vérifications supplémentaires
  if (isset($userValues[DviHelper::FIELD_IS_DVI_PRODUCT_NAME])
    && $userValues[DviHelper::FIELD_IS_DVI_PRODUCT_NAME] == "1" ) {


    #Petite gestion pour la langue, pour afficher le bon element....
    $node = $form_state->getFormObject()->getEntity();
    $langcode = $node->langcode->value;

    ##Si la lang n'est pas fr ou en, je met un message d'erreur et je quitte
    if ($langcode != "en" && $langcode != "fr") {
      $form_state->setErrorByName(DviHelper::FIELD_IS_DVI_PRODUCT_NAME,
        t("DVI product is not available in your language. Please check \"No\" at DVI Product to process"));
      return;
    }


    ## 1. Il faut que l'utilisateur ait selectionné la subhome "Produits DVI"

    ##Je recupère les éléments selectionnés dans la taxo Subhome (false si le field n'existe pas..)
    $field_taxoSubhome = isset($userValues[DviHelper::FIELD_SUBHOME_NAME])
      ? $userValues[DviHelper::FIELD_SUBHOME_NAME]
      : false;

    $isTaggedDvi = false;                    ##Pour connaitre le résultat
    $taxoSubhomeTid = DviHelper::getProductDviSubhomeTid($content_language);  ##Je recupère le tid de la taxo ProductDvi
    ##translation faite toute seule par la fonction

    ##Je boucle sur tous les éléments selectionnés
    if (is_array($field_taxoSubhome)) {
      foreach ($field_taxoSubhome as $element) {

        ##Si un des elements est taggué, je passe à true
        if ($element == $taxoSubhomeTid) {
          $isTaggedDvi = true;
        }
      }
    }

    ##Si on n'a pas trouvé la taxo Subhome Produit DVI, je fais remonter une erreur
    if (!$isTaggedDvi) {

      ##On remonte l'erreur
      $form_state->setErrorByName(DviHelper::FIELD_SUBHOME_NAME,
        t("Since you declare the product as DVI, you must select \"Products DVI\" as a subhome"));
    }

    ## 2. Il faut que l'utilisateur ait selectionné au moins un element dans Market Segment

    ##Je recupère la valeur rentrée pour la taxo DVI Market Segment
    $field_mstaco = isset($userValues[DviHelper::FIELD_DVI_MARKET_SEGMENT_NAME])
      ? $userValues[DviHelper::FIELD_DVI_MARKET_SEGMENT_NAME]
      : false;

    ##Si on ne recup pas d'array, ou si l'array est vide (ie. rien n'a ete selectionné)
    ## je remonte un message d'erreur
    if (!is_array($field_mstaco) || (is_array($field_mstaco) && count($field_mstaco) == 0)) {
      $form_state->setErrorByName(DviHelper::FIELD_DVI_MARKET_SEGMENT_NAME,
        t("Since you declare the product as DVI, you need to select at least one element of the DVI Market Segment taxonomy"));
    }
  }
}


/**
 * Implements hook_pathauto_alias_alter().
 */
function oab_backoffice_pathauto_alias_alter(&$alias, array &$context) {

    ##Modification de l'alias créé lors de la creation d'un produit DVI
    ## (un produit DVI est un contenu de type produit, mais l'URL diffère)
    if (isset($context['bundle']) && $context['bundle'] == 'product'
        && isset($context['op']) && $context['op'] == "insert"
        && isset($context['data']['node'])
    ) {
        ##Recuperation du produit
        $node = $context['data']['node'];

        ##je recupère la valeur contenue dans l'element IsDviProduct
        $isDvi_array = $node->get(DviHelper::FIELD_IS_DVI_PRODUCT_NAME)->getValue();
        if (is_array($isDvi_array) && count($isDvi_array) > 0 ) {
            $isDvi_value = $isDvi_array[0]['value'];

            #Si on a un produit DVI
            if ($isDvi_value == "1") {

                ##Je sépare l'alias pré-créé par le système
                $alias_parts = explode('/', $alias);

                ##Si le premier element du tableau est un string vide, je le supprime
                ## (très probable que l'URL commence par "/" et dans ce cas, PHP ajoute un string vide au debut)
                if (isset($alias_parts[0]) && $alias_parts[0] == "") {
                    array_shift($alias_parts);
                }

                #j'ajoute en début la partie de l'URL spécifique à DVI
                array_unshift($alias_parts, DviHelper::DVI_PRODUCT_URL);

                ##En bouclant sur tous les éléments, je recrée l'alias
                $newAlias = "";
                foreach ($alias_parts as $part) {
                    $newAlias .= "/$part";
                }

                ## Puis je set l'alias avec le mien
                $alias = $newAlias;
            }
        }
    }

}

/**
 * Implements hook_theme().
 */
function oab_backoffice_theme($existing, $type, $theme, $path) {
    return [
        'oab_export_file_list__ending_page'  => [
            'variables' => [
                "file_url"      => NULL,
                "origin_url"    => NULL
            ],
            'template'  => 'OabExportFileList/oab-export-file-list--ending-page'
        ],
    ];
}
