<?php

use Drupal\Core\Menu\MenuLinkInterface;
use Drupal\menu_link_content\Entity\MenuLinkContent;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;


function oab_frontoffice_preprocess_menu(&$variables) {
  if (isset($variables['items'])
    && is_array($variables['items'])) {
    foreach ($variables['items'] as &$item) {
      $menuLinkEntity = oab_frontoffice_load_link_entity_by_link($item['original_link']);
      if (!empty($menuLinkEntity)) {
        if (!empty($menuLinkEntity->link->first()->options['target'])) {
          $item['url']->setOption('target', $menuLinkEntity->link->first()->options['target']);
        }
      }
    }
  }
}

function oab_frontoffice_load_link_entity_by_link(MenuLinkInterface $menuLinkContentPlugin) {
  $entity = NULL;
  if ($menuLinkContentPlugin instanceof Drupal\menu_link_content\Plugin\Menu\MenuLinkContent) {
    list($entity_type, $uuid) = explode(':', $menuLinkContentPlugin->getPluginId(), 2);
    $entity = \Drupal::entityManager()->loadEntityByUuid($entity_type, $uuid);
  }
  return $entity;
}

function oab_frontoffice_link_alter(&$variables){
  $languages = \Drupal::languageManager()->getLanguages();

  if (isset($variables['url'])){
    try{
      $uri = $variables['url']->getUri();

      foreach($languages AS $key => $value) {
        $langcode = $value->getId();

        if ($uri === 'base:<front_' . $langcode . '>'){
          $new_url = \Drupal\Core\Url::fromRoute('<front>', array(), array());
          $variables['options']['language'] = $value;
          $variables['url'] = $new_url;
        }
      }
    }
    catch(\UnexpectedValueException $e){

    }
  }
}


/**
 * Implements hook_entity_view_alter().
 * @param array $build
 * @param EntityInterface $entity
 * @param EntityViewDisplayInterface $display
 */
function oab_frontoffice_entity_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  // Cheking view_mode for node.
  if ($entity->getEntityType()->id() == 'node') {
    if (!empty($build['#attached']['html_head_link'])) {
      _remove_header_links($build);
    }
  }
}

function _remove_header_links(array &$attachments) {
  // Cheking html_head on attached tags in head.
  if (!isset($attachments['#attached']['html_head_link'])) {
    return;
  }

  // Array to unset.
  $unset_html_head_link = [
    'shortlink',
    'delete-form',
    'edit-form',
    'version-history',
    'revision',
    'display',
    'drupal:content-translation-overview',
    'drupal:content-translation-add',
    'drupal:content-translation-edit',
    'drupal:content-translation-delete',
  ];
  // Unset loop.
  foreach ($attachments['#attached']['html_head_link'] as $key => $value) {
    if (isset($value[0]['rel']) && in_array($value[0]['rel'], $unset_html_head_link)) {
      unset($attachments['#attached']['html_head_link'][$key]);
    }
  }
}

function oab_frontoffice_node_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  if ($build['#view_mode'] == 'full') {
		$content_type = $entity->bundle();
		if (in_array($content_type, array('magazine', 'blog_post', 'document', 'simple_page', 'full_html'))) {
      $theme_term = '';

      $field_solution = isset($entity->field_solution) ? $entity->field_solution->getValue() : array();
      $field_industry = isset($entity->field_industry) ? $entity->field_industry->getValue() : array();
      $field_insight = isset($entity->field_insight) ? $entity->field_insight->getValue() : array();

      $field_blog_thematic = isset($entity->field_blog_thematic) ? $entity->field_blog_thematic->getValue() : array();
      $field_document_thematic = isset($entity->field_document_thematic) ? $entity->field_document_thematic->getValue() : array();
      $field_magazine_thematic = isset($entity->field_magazine_thematic) ? $entity->field_magazine_thematic->getValue() : array();

      if (!empty($field_insight)){
            $theme_term = $field_insight[0]['target_id'];
      }
      elseif (!empty($field_blog_thematic)){
                $theme_term = $field_blog_thematic[0]['target_id'];
            }
      elseif (!empty($field_document_thematic)){
            $theme_term = $field_document_thematic[0]['target_id'];
      }
      elseif (!empty($field_magazine_thematic)){
          $theme_term = $field_magazine_thematic[0]['target_id'];
      }
      elseif (!empty($field_industry)){
            $theme_term = $field_industry[0]['target_id'];
      }
      elseif (!empty($field_solution)){
            $theme_term = $field_solution[0]['target_id'];
      }

      if ($theme_term != ''){
        $term = \Drupal\taxonomy\Entity\Term::load($theme_term);
        //oabt($term, true);
        if(isset($term)) {
	        $build['theme_term'] = array(
		        '#markup' => $term->getName(),
                'id' => $term->id(),
	        );
        }
      }
		}
		if ($content_type == 'product') {
			//on deserialise les données à passer au template
			$field_axiome_data = isset($entity->field_axiome_data) ? unserialize($entity->field_axiome_data->value) : array();
			if(count($field_axiome_data) > 0)
			{
				$build['axiome_data'] = $field_axiome_data;
			}
		}
	}
}

/**
 * cleane les options du menu déroulant des filtres exposés
 * @param $options du tableau
 */
function clean_exposed_filters_by_language($options, $txtAll){
	$current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();
	foreach($options as $key=>$value){
		if($key != 'All'){
			$term = \Drupal\taxonomy\Entity\Term::load($key);
			if(isset($term) && $term != null) {
				$lang = $term->language();
				if ( $lang->getId() != $current_language ) {
					unset( $options[ $key ] );
				}
			}
		}else{
			$options['All'] = t($txtAll);
		}
	}
	return $options;
}

/**
 * Implements hook_views_query_alter().
 */
function oab_frontoffice_form_views_exposed_form_alter(&$form, &$form_state) {
  // subhome blogs
  if ($form['#id'] == 'views-exposed-form-subhomes-page-blog') {
    $themes = clean_exposed_filters_by_language(
      $form['field_blog_thematic_target_id']['#options'],
      'Thematic'
    );
    $form['field_blog_thematic_target_id']['#options'] = $themes;
  }
  // subhome magazine
  if ($form['#id'] == 'views-exposed-form-subhomes-page-magazine') {
    $themes = clean_exposed_filters_by_language(
      $form['field_magazine_thematic_target_id']['#options'],
      'Thematic'
    );
    $form['field_magazine_thematic_target_id']['#options'] = $themes;
      $years = clean_exposed_filters_by_language(
          $form['field_year_target_id']['#options'],
          'Year'
      );
      $form['field_year_target_id']['#options'] = $years;

      $months = clean_exposed_filters_by_language(
          $form['field_month_target_id']['#options'],
          'Month'
      );
      $form['field_month_target_id']['#options'] = $months;
  }
  // subhome mediatheque
  if ($form['#id'] == 'views-exposed-form-subhomes-page-document') {
    $themes = clean_exposed_filters_by_language(
      $form['field_blog_thematic_target_id']['#options'],
      'Thematic'
    );
    $form['field_blog_thematic_target_id']['#options'] = $themes;

    $types = clean_exposed_filters_by_language(
      $form['field_document_type_target_id']['#options'],
      'Type'
    );
    $form['field_document_type_target_id']['#options'] = $types;

    $jobs = clean_exposed_filters_by_language(
      $form['field_jobs_target_id']['#options'],
      'Profession'
    );
    $form['field_jobs_target_id']['#options'] = $jobs;

    $industries = clean_exposed_filters_by_language(
      $form['field_industry_target_id']['#options'],
      'Industry'
    );
    $form['field_industry_target_id']['#options'] = $industries;
  }
  // subhome presse
  if ($form['#id'] == 'views-exposed-form-subhomes-page-press') {
    $targets = clean_exposed_filters_by_language(
      $form['field_type_target_id']['#options'],
      'Type'
    );
    $form['field_type_target_id']['#options'] = $targets;

    $solutions = clean_exposed_filters_by_language(
      $form['field_solution_target_id']['#options'],
      'Solution'
    );
    $form['field_solution_target_id']['#options'] = $solutions;

    $years = clean_exposed_filters_by_language(
      $form['field_year_target_id']['#options'],
      'Year'
    );
    $form['field_year_target_id']['#options'] = $years;

    $months = clean_exposed_filters_by_language(
      $form['field_month_target_id']['#options'],
      'Month'
    );
    $form['field_month_target_id']['#options'] = $months;
  }
  // subhome produits
  if ($form['#id'] == 'views-exposed-form-subhomes-page-catalogue') {
    $solutions = clean_exposed_filters_by_language(
      $form['field_solution_target_id']['#options'],
      'Solution'
    );
    $form['field_solution_target_id']['#options'] = $solutions;

    $industries = clean_exposed_filters_by_language(
      $form['field_industry_target_id']['#options'],
      'Industry'
    );
    $form['field_industry_target_id']['#options'] = $industries;

    $jobs = clean_exposed_filters_by_language(
      $form['field_jobs_target_id']['#options'],
      'Profession'
    );
    $form['field_jobs_target_id']['#options'] = $jobs;

  }
  // subhome temoignages
  if ($form['#id'] == 'views-exposed-form-subhomes-page-customer') {
    $solutions = clean_exposed_filters_by_language(
      $form['field_solution_target_id']['#options'],
      'Solution'
    );
    $form['field_solution_target_id']['#options'] = $solutions;

    $industries = clean_exposed_filters_by_language(
      $form['field_industry_target_id']['#options'],
      'Industry'
    );
    $form['field_industry_target_id']['#options'] = $industries;

    $jobs = clean_exposed_filters_by_language(
      $form['field_jobs_target_id']['#options'],
      'Profession'
    );
    $form['field_jobs_target_id']['#options'] = $jobs;
  }
  // subhome partenaires
  if ($form['#id'] == 'views-exposed-form-subhomes-page-partners') {
    $solutions = clean_exposed_filters_by_language(
      $form['field_solution_target_id']['#options'],
      'Solution'
    );
    $form['field_solution_target_id']['#options'] = $solutions;

    $types = clean_exposed_filters_by_language(
      $form['field_types_target_id']['#options'],
      'Category'
    );
    $form['field_types_target_id']['#options'] = $types;

    $regions = clean_exposed_filters_by_language(
      $form['field_regions_target_id']['#options'],
      'Geography'
    );
    $form['field_regions_target_id']['#options'] = $regions;
  }
}

function oab_frontoffice_system_breadcrumb_alter(\Drupal\Core\Breadcrumb\Breadcrumb &$breadcrumb, \Drupal\Core\Routing\RouteMatchInterface $route_match, array $context) {
  if ($route_match && $node = $route_match->getParameter('node')) {
    $breadcrumb->addCacheableDependency($node);
  }
}
