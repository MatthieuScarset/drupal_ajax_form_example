<?php

use Drupal\oab_hub\Controller\OabHubController;
use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;

/**
 * Pour le formulaire d'ajout d'une taxo Hub, je n'affiche que les subhomes de la langue en cours
 */
function oab_hub_form_taxonomy_term_hub_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
    $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();
    $tids = array_keys($form[OabHubController::FIELD_SUBHOMES_ID]['widget']['#options']);
    $terms = \Drupal\taxonomy\Entity\Term::loadMultiple($tids);
    foreach ($terms as $term) {
        $lang = $term->language();
        if ( $lang->getId() != $current_language ) {
            unset($form[OabHubController::FIELD_SUBHOMES_ID]['widget']['#options'][$term->id()]);
        }
    }

    #Pour les modifs, je bloque le machine_name
    $isNew = $form_state->getFormObject()->getEntity()->isNew();
    $isNewTranslation = $form_state->getFormObject()->getEntity()->isNewTranslation();
    if (!$isNew) {
        $form[OabHubController::FIELD_MN_SUFFIXE_ID]['widget'][0]['value']['#attributes']['disabled'] = 'disabled';
        $form[OabHubController::FIELD_URL_ID]['widget'][0]['value']['#attributes']['disabled'] = 'disabled';
    }
}

/**
 * hook_ENTITY_TYPE_insert
 * Hook pour créer les menus/blocks à la création d'un taxo HUB
 */
function oab_hub_taxonomy_term_presave(\Drupal\taxonomy\Entity\Term $term) {
    /**
     * Ajouter dans les if un test sur un paramètre ajouté dans l'array
     * des infos du term dans l'update pour l'ajout du term "portail"
     */

    ##on ne le fait que pour la création des termes pour le HUB
    if ($term->getVocabularyId() == OabHubController::HUB_VOCABULARY_ID &&
        ( $term->isNew() || $term->isNewTranslation())) {
            OabHubController::createMachineNameSuffixe($term);
            OabHubController::createMenus($term);
            OabHubController::checkUrl($term);
            OabHubController::createBlocks($term);
    }
}

/**
 * suppression des menus à la suppression d'un terme
 */
function oab_hub_taxonomy_term_delete(\Drupal\taxonomy\Entity\Term $term)  {
    if ($term->getVocabularyId() == OabHubController::HUB_VOCABULARY_ID) {

        #Je boucle sur toutes les langues pour supprimer les menus associés
        # aux traductions (le hook_translation_delete n'est pas appelé dans ce cas là)
        $languages = $term->getTranslationLanguages(false);
        foreach ( $languages as $langcode => $langinfo) {
            OabHubController::deleteMenus($term->getTranslation($langcode));
            OabHubController::deleteBlocks($term->getTranslation($langcode));
        }
        OabHubController::deleteMenus($term);
        OabHubController::deleteBlocks($term);
        OabHubController::deleteUrl($term);
    }
}

/**
 * suppression des menus à la suppression de la trad d'un terme
 */
function oab_hub_taxonomy_term_translation_delete(\Drupal\taxonomy\Entity\Term $translation) {
    if ($translation->getVocabularyId() == OabHubController::HUB_VOCABULARY_ID) {
        OabHubController::deleteMenus($translation);
        OabHubController::deleteBlocks($translation);
    }
}


/**
 * Implements hook_views_query_alter().
 */
function oab_hub_views_query_alter(Drupal\views\ViewExecutable $view, Drupal\views\Plugin\views\query\QueryPluginBase $query) {


    ## Recuperation de tous les termes
    $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')
        ->loadTree(OabHubController::HUB_VOCABULARY_ID,0,1,TRUE);
    $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();

    ##Je recupère et je découpe l'URL
    $uri = \Drupal::request()->getRequestUri();
    $uri_parts = explode('/', $uri);
    if ($uri_parts[0] === "") {
        array_shift($uri_parts);
    }

    if ($view->id() === "subhomes" && isset($uri_parts[1])) {

        ## je recupère le term de l'URL
        $pageTerm = false;
        foreach ($terms as $term) {
            $translated_term = $term->getTranslation($langcode);

            ## Je teste sur l'URL de la trad du term pour l'affichage en cours
            $term_url = $translated_term->get(OabHubController::FIELD_URL_ID)->first()->getString();
            if ($uri_parts[1] === $term_url) {

                ##Si je trouve une URl qui correspond, je recupère le term pour faire le filtre
                $pageTerm = $term;
            }

        }

        #Si on a trouvé un terme dont l'URL correspond à notre URl,
        # on complete la query avec notre term
        if ($pageTerm !== false) {
            foreach ($query->where as $key_where => $where) {
                foreach ($where['conditions'] as $key_condition => $condition) {
                    if (isset($condition['field'])
                        && $condition['field'] == "node__field_hub.field_hub_target_id") {
                        unset($query->where[$key_where]['conditions'][$key_condition]);
                    }
                }
            }

            ##J'ajoute la condition pour filtrer sur notre taxo
            $query->where[0]['conditions'][] = [
                'field' => "node__field_hub.field_hub_target_id = :node__field_hub_field_hub_target_id",
                'value' => [
                    'node__field_hub_field_hub_target_id' => $term->id()
                ],
                'operator' => "formula"
            ];
        }
    }

}
