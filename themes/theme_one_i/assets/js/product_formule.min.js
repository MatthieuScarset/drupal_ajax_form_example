(()=>{"use strict";const t=class{constructor(t,e){this.$root=t,this.$parent=e,this.$inputName=this.$root.dataset.inputName,this.$submit=this.$root.querySelector("button.formule-submit"),this.$submit.addEventListener("click",(t=>{t.preventDefault(),this.$parent.setResult(this.getTarget(),this.getValue())})),this.$inputs=[],Array.from(this.$root.querySelectorAll("li")).forEach((t=>{this.$inputs.push(t),t.querySelector("input").addEventListener("change",(()=>{this.unactiveAll(),t.classList.add("active"),this.$submit.disabled=!1}))}))}unactiveAll(){this.$inputs.forEach((t=>{t.classList.remove("active")}))}getTarget(){return this.$root.dataset.target}getValue(){return this.$root.querySelector(`input[name="${this.$inputName}"]:checked`)?this.$root.querySelector(`input[name="${this.$inputName}"]:checked`).value:null}resetValue(){this.$root.querySelector(`input[name="${this.$inputName}"]:checked`)&&(this.$root.querySelector(`input[name="${this.$inputName}"]:checked`).checked=!1,this.unactiveAll(),this.$submit.disabled=!0)}};class e{static replaceToken(t,e=[]){let s=t,i=t.match(/{[\w]*\}/g);return i&&i.forEach((t=>{let i=t.replace(/{|}/g,""),r=e[i];s=s.replace(t,r)})),s}}const s=class{constructor(t){this.$root=t,this.$baseLabel=this.$root.dataset.label,this.$progressBar=this.$root.querySelector("progress"),this.$progressLabel=this.$root.querySelector(".progressbar-label"),this.$currentStep=1}_changeStep(){this.$progressBar.value=this.$currentStep,this.$progressLabel.innerHTML=e.replaceToken(this.$baseLabel,{num_question:this.$currentStep})}nextStep(){this.$currentStep++,this._changeStep()}previousStep(){this.$currentStep--,this._changeStep()}goToStep(t){this.$currentStep=t,this._changeStep()}getCurrentStep(){return this.$currentStep}display(){this.$root.classList.remove("d-none")}restart(){this.$root.classList.add("d-none"),this.$currentStep=1}};const i=class{constructor(t,e){this.$root=t,this.$parent=e,this.$drupalSettings=window.drupalSettings,this.$fieldConfigs=window.drupalSettings.formuleField||[]}show(){this.$root.style.opacity=0,this.$root.classList.remove("d-none"),this.$root.style.opacity=1}setFormuleField(t,s){if(!this.$fieldConfigs[t])return!1;let i=Object.values(this.$fieldConfigs[t].emptyConfigs).find((t=>t.inputs&&Object.values(t.inputs).find((t=>t===s))));i||(i=this.$fieldConfigs[t].emptyConfigs.default);const r={answer:this.$fieldConfigs[t].options[this.$parent.getFieldValue(t)]||""},o=(new DOMParser).parseFromString(i.no_result_title,"text/html").documentElement.textContent;this.$root.querySelector("[data-field=no-result-title]").innerHTML=e.replaceToken(o,r),this.$root.querySelector("[data-field=no-result-sentence]").innerHTML=e.replaceToken(i.no_result_sentence,r);const a=this.$root.querySelector("[data-field=no-result-link]");return a.setAttribute("href",i.button_link),a.innerHTML=i.button_text,!0}};const r=class{constructor(t){this.$root=t}async setUp(t,e){const s=new URLSearchParams(e);fetch(`/api/formule_package/${t}?${s.toString()}`).then((t=>t.text())).then((t=>{this.$root.innerHTML=t}))}show(){this.$root.style.opacity=0,this.$root.classList.remove("d-none"),this.$root.style.opacity=1}hide(){delete this.$root.style.opacity}};const o=class{constructor(t,e){this.$stacks=Array.from(e),this.$parent=t,this.$fieldConfigs=window.drupalSettings.formuleField||[],this.$drupal=window.Drupal,this.$defaultTemplate=`<div class="stack-item" data-item="" ><div class="stack-item-result"></div><a class="o-link" data->${this.$drupal.t("edit")}</a></div>`,this.$results={}}display(){this.$stacks.forEach((t=>{t.classList.remove("d-none")}))}setResult(t,s){this.display(),this.$results[t]=s,this.$stacks.forEach((i=>{i.querySelector(`[data-item=${t}]`)?i.querySelector(`[data-item=${t}] .stack-item-result`).innerHTML=e.replaceToken(this.$fieldConfigs[t].resultSentence,{answer:this.$fieldConfigs[t].options[s]||""}):i.querySelector(".result-items").append(this._createItem(t,s))}))}_createItem(t,s){const i=document.createElement("template");return i.innerHTML=this.$defaultTemplate.trim(),i.content.querySelector(".stack-item").dataset.item=t,i.content.querySelector("a.o-link").addEventListener("click",(()=>{this.$parent.goToField(t)})),i.content.querySelector(".stack-item-result").innerHTML=e.replaceToken(this.$fieldConfigs[t].resultSentence,{answer:this.$fieldConfigs[t].options[s]||""}),i.content.firstChild}removeResult(t){this.$stacks.forEach((e=>{const s=e.querySelector(`[data-item=${t}]`);s&&s.parentElement.removeChild(s)})),this.$results[t]&&delete this.$results[t]}};class a{constructor(e){this.$root=e,this.$modal=jQuery(this.$root.querySelector(".modal.modal-product-formule")),this.$formuleId=this.$root.dataset.formule||0,this.$content=this.$root.querySelector(".modal-content"),this.$modalIsOpen=!1,this.$modal.on("shown.bs.modal",(()=>{this.$modalIsOpen=!0,this._reset()})),this.$progressBar=new s(this.$root.querySelector(".progressbar")),this.$resultStep=new r(this.$root.querySelector('[data-step="result"]')),this.$resultStack=new o(this,this.$root.querySelectorAll(".result-stack")),this.$fields=Array.from(this.$root.querySelectorAll('.modal-content .right-zone [data-step="process"]')),this.$fields.forEach((t=>{t.ontransitionend=t=>{"opacity"===t.propertyName&&0===this.$root.style.opacity&&this.$root.classList.add("d-none")}})),this.$formContact=new i(this.$root.querySelector('[data-step="contact-form"]'),this),this.$root.querySelector('.modal-content .left-zone [data-step="reception"] .btn.btn-begin').addEventListener("click",(()=>{this._start()})),this.$steps=[],Array.from(this.$root.querySelectorAll(".formule-field")).forEach((e=>{this.$steps.push(new t(e,this))}))}get formuleName(){return this.$root.dataset.formuleName}get formuleId(){return this.$root.dataset.formule}get formulePrice(){return this.$root.dataset.formulePrice}getFieldValue(t){return this._getFieldValues()[t]||null}setResult(t,e){this.$resultStack.setResult(t,e),this.nextField()}nextField(){this._packageExists().then((t=>{if(t){const t=this.$fields.findIndex((t=>!t.classList.contains("d-none")));this.$fields[t]&&(this.$fields[t].addEventListener("transitionend",(()=>{this.$fields[t].classList.add("d-none"),this.$fields[t+1]?(this.showField(this.$fields[t+1]),this.$progressBar.nextStep()):this._toResult()}),{capture:!1,once:!0}),this.$fields[t].style.opacity=0)}else{const t=this.$fields.findIndex((t=>!t.classList.contains("d-none")));this.$fields[t]&&(this.$fields[t].addEventListener("transitionend",(()=>{this.$fields[t].classList.add("d-none"),this._toContactForm(Object.keys(this._getFieldValues()).pop())}),{capture:!1,once:!0}),this.$fields[t].style.opacity=0)}}))}showField(t){t.classList.remove("d-none"),t.style.opacity=1}goToField(t){const e=this.$root.querySelector(`[data-target=${t}]`);if(e){const s=this.$fields.findIndex((e=>null!==e.querySelector(`[data-target="${t}"]`)));-1!==s&&(alert("i'm here"),this.$progressBar.goToStep(s+1));const i=e.closest("[data-step]"),r="process"===this.$content.dataset.show?this.$root.querySelector('[data-step="process"]:not(.d-none)'):this.$root.querySelector(`[data-step="${this.$content.dataset.show}"]`);if(r){const e=this.$steps.findIndex((e=>e.getTarget()===t));this.$steps.forEach(((t,s)=>{s>e&&(t.resetValue(),this.$resultStack.removeResult(t.getTarget()))})),r.addEventListener("transitionend",(t=>{t.propertyName&&"opacity"===t.propertyName&&(r.classList.add("d-none"),this.$content.dataset.show="process",i.classList.remove("d-none"),i.style.opacity=1)}),{capture:!1,once:!0}),r.style.opacity=0}}}_start(){this.$content.dataset.show="process",this.$root.querySelector(".right-zone").ontransitionend=t=>{"width"===t.propertyName&&this.$fields[0]&&this.showField(this.$fields[0])},this.$progressBar.display()}_reset(){this.$steps.forEach((t=>{t.resetValue(),this.$resultStack.removeResult(t.getTarget())})),this._show("reception"),this.$progressBar.restart()}_show(t){this.$content.dataset.show=t}_backToReception(){this.$content.dataset.show="reception"}_toContactForm(t){this.$formContact.setFormuleField(t,this.getFieldValue(t))&&(this._show("contact-form"),this.$formContact.show())}_toResult(){this.$resultStep.setUp(this.$formuleId,this._getFieldValues()).then((()=>{this._show("result"),this.$resultStep.show()}))}async _packageExists(){const t=new URLSearchParams(this._getFieldValues());return(await fetch(`/api/formule_package/exists/${this.$formuleId}?${t.toString()}`,{headers:{Accept:"application/json"}})).ok}_getFieldValues(){const t={};return this.$steps.forEach((e=>{e.getValue()&&(t[e.getTarget()]=e.getValue())})),t}}document.addEventListener("DOMContentLoaded",(()=>{Array.from(document.querySelectorAll("[data-formule]")).forEach((t=>{new a(t)}))})),window.ProductFormuleSelector=a})();