(()=>{"use strict";const t=class{constructor(t,e){this.$root=t,this.$parent=e,this.$inputName=this.$root.dataset.inputName,this.$submit=this.$root.querySelector("button.formule-submit"),this.$submit.addEventListener("click",(t=>{t.preventDefault(),this.$parent.setResult(this.getTarget(),this.getValue())})),this.$inputs=[],Array.from(this.$root.querySelectorAll("li")).forEach((t=>{this.$inputs.push(t),t.querySelector("input").addEventListener("change",(()=>{this.unactiveAll(),t.classList.add("active"),this.$submit.disabled=!1}))}))}unactiveAll(){this.$inputs.forEach((t=>{t.classList.remove("active")}))}getTarget(){return this.$root.dataset.target}getValue(){return this.$root.querySelector(`input[name="${this.$inputName}"]:checked`)?this.$root.querySelector(`input[name="${this.$inputName}"]:checked`).value:null}};class e{static replaceToken(t,e=[]){let s=t,o=t.match(/{[\w]*\}/g);return o&&o.forEach((t=>{let o=t.replace(/{|}/g,""),i=e[o];s=s.replace(t,i)})),s}}const s=class{constructor(t){this.$root=t,this.$baseLabel=this.$root.dataset.label,this.$progressBar=this.$root.querySelector("progress"),this.$progressLabel=this.$root.querySelector(".progressbar-label"),this.$currentStep=1}_changeStep(){this.$progressBar.value=this.$currentStep,this.$progressLabel.innerHTML=e.replaceToken(this.$baseLabel,{num_question:this.$currentStep})}nextStep(){this.$currentStep++,this._changeStep()}previousStep(){this.$currentStep--,this._changeStep()}goToStep(t){this.$currentStep=t,this._changeStep()}getCurrentStep(){return this.$currentStep}display(){this.$root.classList.remove("d-none")}};const o=class{constructor(t,e){this.$root=t,this.$parent=e,this.$fieldConfigs=window.drupalSettings.formuleField||[]}show(){this.$root.style.opacity=0,this.$root.classList.remove("d-none"),this.$root.style.opacity=1}setFormuleField(t){if(!this.$fieldConfigs[t])return!1;let s=Object.values(this.$fieldConfigs[t].emptyConfigs).find((e=>e.inputs&&Object.values(e.inputs).find((e=>e===t))));s||(s=this.$fieldConfigs[t].emptyConfigs.default);const o=(new DOMParser).parseFromString(s.no_result_title,"text/html").documentElement.textContent;return this.$root.querySelector("[data-field=no-result-title]").innerHTML=e.replaceToken(o,{answer:this.$fieldConfigs[t].options[this.$parent.getFieldValue(t)]||""}),this.$root.querySelector("[data-field=no-result-sentence]").innerHTML=s.no_result_sentence,this.$root.querySelector("[data-field=no-result-link]").setAttribute("href",s.button_link),this.$root.querySelector("[data-field=no-result-link]").innerHTML=s.button_text,!0}};const i=class{constructor(t){this.$root=t}async setUp(t,e){const s=new URLSearchParams(e);fetch(`/api/formule_package/${t}?${s.toString()}`).then((t=>t.text())).then((t=>{this.$root.innerHTML=t}))}show(){this.$root.style.opacity=0,this.$root.classList.remove("d-none"),this.$root.style.opacity=1}hide(){delete this.$root.style.opacity}};const r=class{constructor(t,e){this.$root=t,this.$parent=e,this.$fieldConfigs=window.drupalSettings.formuleField||[],this.$drupal=window.Drupal,this.$defaultTemplate=`<div class="stack-item" data-item="" ><div class="stack-item-result"></div><button class="btn btn-link" >${this.$drupal.t("edit")}</button></div>`,this.results={}}display(){this.$root.classList.remove("d-none")}setResult(t,s){this.display(),this.results[t]=s,this.$root.querySelector(`[data-item=${t}]`)?this.$root.querySelector(`[data-item=${t}] .stack-item-result`).innerHTML=e.replaceToken(this.$fieldConfigs[t].resultSentence,{answer:this.$fieldConfigs[t].options[s]||""}):this.$root.append(this._createItem(t,s))}_createItem(t,s){const o=document.createElement("template");return o.innerHTML=this.$defaultTemplate.trim(),o.content.querySelector(".stack-item").dataset.item=t,o.content.querySelector("button").addEventListener("click",(()=>{this.$parent.goToField(t)})),o.content.querySelector(".stack-item-result").innerHTML=e.replaceToken(this.$fieldConfigs[t].resultSentence,{answer:this.$fieldConfigs[t].options[s]||""}),o.content.firstChild}};class n{constructor(e){this.$root=e,this.$modal=jQuery(this.$root.querySelector(".modal.modal-product-formule")),this.$formuleId=this.$root.dataset.formule||0,this.$content=this.$root.querySelector(".modal-content"),this.$modalIsOpen=!1,this.$modal.on("shown.bs.modal",(()=>{this.$modalIsOpen=!0})),this.$modal.on("hide.bs.modal",(()=>{this.$modalIsOpen=!1,this._reset()})),this.$progressBar=new s(this.$root.querySelector(".progressbar")),this.$resultStep=new i(this.$root.querySelector('[data-step="result"]')),this.$resultStack=new r(this.$root.querySelector(".result-stack"),this),this.$fields=Array.from(this.$root.querySelectorAll('.modal-content .right-zone [data-step="process"]')),this.$fields.forEach((t=>{t.ontransitionend=t=>{"opacity"===t.propertyName&&0===this.$root.style.opacity&&this.$root.classList.add("d-none")}})),this.$formContact=new o(this.$root.querySelector('[data-step="contact-form"]'),this),this.$root.querySelector('.modal-content .left-zone [data-step="reception"] .btn.btn-begin').addEventListener("click",(()=>{this._start()})),this.$steps=[],Array.from(this.$root.querySelectorAll(".formule-field")).forEach((e=>{this.$steps.push(new t(e,this))}))}getFieldValue(t){return this._getFieldValues()[t]||null}setResult(t,e){this.$resultStack.setResult(t,e),this.nextField()}nextField(){this._packageExists().then((t=>{if(t){const t=this.$fields.findIndex((t=>!t.classList.contains("d-none")));this.$fields[t]&&(this.$fields[t].addEventListener("transitionend",(()=>{this.$fields[t].classList.add("d-none"),this.$fields[t+1]?(this.showField(this.$fields[t+1]),this.$progressBar.nextStep()):this._toResult()}),{capture:!1,once:!0}),this.$fields[t].style.opacity=0)}else{const t=this.$fields.findIndex((t=>!t.classList.contains("d-none")));this.$fields[t]&&(this.$fields[t].addEventListener("transitionend",(()=>{this.$fields[t].classList.add("d-none"),this._toContactForm(Object.keys(this._getFieldValues()).pop())}),{capture:!1,once:!0}),this.$fields[t].style.opacity=0)}}))}showField(t){t.classList.remove("d-none"),t.style.opacity=1}goToField(t){const e=this.$root.querySelector(`[data-target=${t}]`);if(e){const s=this.$fields.findIndex((e=>null!==e.querySelector(`[data-target="${t}"]`)));-1!==s&&this.$progressBar.goToStep(s+1);const o=e.closest("[data-step]"),i="process"===this.$content.dataset.show?this.$root.querySelector('[data-step="process"]:not(.d-none)'):this.$root.querySelector(`[data-step="${this.$content.dataset.show}"]`);i&&(i.addEventListener("transitionend",(t=>{t.propertyName&&"opacity"===t.propertyName&&(i.classList.add("d-none"),this.$content.dataset.show="process",o.classList.remove("d-none"),o.style.opacity=1)}),{capture:!1,once:!0}),i.style.opacity=0)}}previousField(){}_start(){this.$content.dataset.show="process",this.$root.querySelector(".right-zone").ontransitionend=t=>{"width"===t.propertyName&&this.$fields[0]&&this.showField(this.$fields[0])},this.$progressBar.display()}_reset(){}_show(t){this.$content.dataset.show=t}_backToReception(){this.$content.dataset.show="reception"}_toContactForm(t){this.$formContact.setFormuleField(t)&&(this._show("contact-form"),this.$formContact.show())}_toResult(){this.$resultStep.setUp(this.$formuleId,this._getFieldValues()).then((()=>{this._show("result"),this.$resultStep.show()}))}async _packageExists(){const t=new URLSearchParams(this._getFieldValues());return(await fetch(`/api/formule_package/exists/${this.$formuleId}?${t.toString()}`,{headers:{Accept:"application/json"}})).ok}_getFieldValues(){const t={};return this.$steps.forEach((e=>{e.getValue()&&(t[e.getTarget()]=e.getValue())})),t}}document.addEventListener("DOMContentLoaded",(()=>{Array.from(document.querySelectorAll("[data-formule]")).forEach((t=>{new n(t)}))})),window.ProductFormuleSelector=n})();