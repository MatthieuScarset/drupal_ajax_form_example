
stages:          # List of stages for jobs, and their order of execution
  - prepare
  - build_drupal
  - build_image


# Include job templates
include:
  - '/ci/.templates.d/sonarqube.yml'

variables:
  COMPTE_PROJET: $COMPTE_PROJET_DEV
  REGISTRY: $INTERNAL_ARTIFACTORY_DOCKER_REGISTRY
  VAULT_ADDR: $VAULT_ADDR
  VAULT_PATH: /prj/portail-obs/compte-projet/
  VAULT_OPTS: "-tls-skip-verify=true"
  VAULT_NAMESPACE: "namespace-portail-obs"
  IMAGE_PATH: portail_obs/$CI_COMMIT_BRANCH
  IMAGE_NAME: php-fpm-nginx


# Sonarqube analyze on .pre
sonarqube:
  extends: .sonarqube_template
  stage: .pre


.build_assets: &build_assets
  stage: build_assets
  image: node
  script:
    - cd $THEME_DIR
    - yarn install
    - yarn build-prod
  artifacts:
    paths:
      - $THEME_DIR/dist
    expire_in: 1 hour

Build assets Theme One I:
  <<: *build_assets
  variables:
    THEME_DIR: 'themes/theme_one_i'


Build assets Theme One I Hub :
  <<: *build_assets
  variables:
    THEME_DIR: 'themes/theme_oab_hub_one_i'


Deploy dev:
  stage: deploy
  dependencies:
    - Build assets Theme One I
    - Build assets Theme One I Hub
  script:
    - mv themes/theme_one_i/dist build/themes/theme_one_i/dist
    - docker build -t php_tmp -f config/docker/cloud/Dockerfile .
    - docker image tag php_tmp $REGISTRY/$IMAGE_PATH/$IMAGE_NAME:$CI_JOB_ID
    - docker image tag php_tmp $REGISTRY/$IMAGE_PATH/$IMAGE_NAME:latest
    - docker image push --all-tags $REGISTRY/$IMAGE_PATH/$IMAGE_NAME
  tags:
    - image_build

