include:
  - local: .dev.gitlab-ci.yml
    rules:
      - if: $CI_COMMIT_BRANCH == "dev"

stages:          # List of stages for jobs, and their order of execution
  #- build
  - deploy


variables:
  DEPLOY_DIR: "/var/www/ruby_test"
  DOCKER_COMPOSE_FILE: "docker-compose.dev.yml"

deploy_dev:
  stage: deploy
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt update -y && apt install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    #First : stop current container and delete code
    - | 
        ssh $SSH_USER@$SSH_DEV_IP << EOF
        if [ -f $DEPLOY/DIR/$DOCKER_COMPOSE_FILE ]; then
            docker-compose -f $DEPLOY_DIR/$DOCKER_COMPOSE_FILE stop
            rm -r $DEPLOY_DIR
        fi
        EOF
    - ssh $SSH_USER@$SSH_DEV_IP mkdir -p $DEPLOY_DIR
    - scp $SSH_USER@$SSH_DEV_IP:$(pwd) $DEPLOY_DIR







